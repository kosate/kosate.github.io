---
layout: single
title: SQL 튜닝 어떻게 접근하고 있나요?
date: 2023-09-05 11:00
categories: 
  - oracle
author: 
tags: 
   - oracle
   - sql tunning
summary: SQL 튜닝할때 접근하는 방법에 대해서 다시 생각해봅니다.
toc : true
---


만약에 SQL 튜닝한다고 하면 어떻게 접근하고 있나요? 가끔 일을 하다보면 왜 일해야되는지, 이유를 잊을때가 있습니다.
튜닝을 위한 튜닝을 하고 있는지 한번 생각해보면 좋을것 같습니다. 

### SQL 튜닝을 위한 접근방법

실행되고 있는 SQL문장을 보면 딱 보이죠? 무슨 의도로 SQL문이 작성되었는지요.
엄청 긴 SQL문을 보면 일단 Plan부터 보고 의례적으로 actual-rows와 estimated-rows를 보며 옵티마이저가 계산한것과 실제 수행된 건수를 비교하면서 왜 이렇게 동작하는지 원인을 찾아내곤 합니다. 
옵티마이저가 잘못된 Plan을 수립하거나, 계산결과가 틀린 이유는 대부분 수집된 통계정보와 실 데이터간이 차이에서 발생되는것 같습니다. 

SQL이 작성되어 실행되면 SQL 튜너는 SQL작성한 의도보다는 오라클 데이터베이스 엔진내에 있는 동작 방식을 분석하여 튜닝하는것 같습니다. 그렇기 때문에 SQL 튜너는 얼만큼 옵티마이저를 잘이해하고 얼만큼 많은 튜닝 경험과 비래하여 튜닝 실력이 쌓이는것 같습니다. 

- SQL 튜닝을 위한 일반적인 접근
  - 힌트를 사용하여 더 나은 PLAN으로 고정한다.
  - 해당 SQL에 적합한 인덱스를 만들어 더 나은 Access 방식으로 변경한다
  - 테이블을 파티셔닝 테이블로 변경하여 데이터 Access 범위를 줄인다
  - 임의적으로 조건을 추가하여 데이터 Access 범위를 줄인다.

우리는 보통 힌트를 사용하여 최고의 Plan이 작성되도록 작성하거나 테이블 구조를 변경하여 데이터 Accss범위를 줄이는 방법을 사용했습니다. 저만 그런가요? (이런 방법이 잘못되었다는것이 아니라, 튜닝의 하나의 방법이고 실력과 경험이있어야만 가능한 일입니다. )
그러나 우리는 의연중에 "작성된 SQL은 작성의도에 맞게 작성되었다" 라는 전제를 가지고 SQL 튜닝을 시작하고 있습니다.

### SQL 작성의도를 물어본적이 있나요?

어느 SQL이 엄청 많이 실행되며 DB부하에 많은 부하를 차지하고 있었습니다. 
아래 SQL구문을 보니 "고객별로 마지막 트랜잭션 시간을 확인하고 싶다"  라는 작성의도가 보였습니다.

```sql
select account_id, max(tnx_ts) last_ts
  from customer_trans
group by account_id 
order by 1
```

SQL문장은 너무 단순해보이지만, 위에 언급한 일반적인 접근방법으로도 충분히 성능 향상시킬수 있습니다.

하지만 또다른 접근 방법도 필요합니다. SQL작성한 개발자에게 물어 보았습니다. 
- "이 SQL은 무슨 의도로 작성한건가요?" 내가 생각하기에는.. 이런의도인것 같은데..
- 개발자 왈~ "아 최근에 활동 했던 고객 목록을 확인하고 싶어요" 라는 말을 했습니다.

의도를 들으니 다양한 아이디어가 떠올랐습니다.   
customer_trans이라는 history 테이블을 조회하는것보다, 
customer_account 테이블에 있는last_login_time 컬럼을 이용하면 좋을것 같다는 생각이 들었습니다.

```sql
select account_id, last_login_time
  from customer_account
order by 1
```

개발자가 바보도 아니고 너무 빈약한 사례인것 같죠?

SQL 튜너가 접근하지 못하는 영역은 실제 업무와 관련된 데이터 파악입니다.
당연히 개발자는 해당 업무에 박식할것이고 이러한 사례가 발생되는 Case는 극히 드물겠죠. 
하지만 개발자도 완벽할수 없기 때문에, 때로는 업무관점에서 다른 방법이 없는지 물어볼수는 있을것 같습니다.

### 결론

어느날 갑자기 저는 SQL문장 자체를 보고 업무를 하고 있다는 생각이 들었습니다. 
SQL를 작성한 사람에게 한번은 물어보고, SQL 자체를 바꿀수 있는 방법, 혹은 더 나은 SQL을 작성할수 있는 방법을 찾는다면 SQL 튜닝을 하지 않고도 성능을 개선시킬수 있다는 생각이 들었습니다. 
좀더 개발자에게 친근감을 갖고 접근하는것도 필요하다고 생각합니다.