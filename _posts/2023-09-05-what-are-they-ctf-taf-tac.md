---
layout: single
title: 오라클에 접속할때 어떤 접속방식을 사용하고 있나요? (CTF, TAF, TAC)
date: 2023-09-05 14:00
categories: 
  - oracle
author: 
tags: 
   - oracle
   - jdbc driver
   - ctf
   - taf
   - tac
   - client
summary: 오라클 데이터베이스 접속시 사용되는 여러가지 접속기술에 대해서 정리하였습니다.
toc : true
---

오라클 데이터베이스 서버에 접속할때 클라이언트를 위하여 여러가지 접속방식을 제공하고 있습니다. 
모두 다 애플리케이션에서 고려되어야하는 접속 기술들인데요? 간략하게 정리해 보았습니다.

### 오라클 클라이언트의 접속 방식 2가지

오라클 데이터베이스 서버 설치 파일도 있지만, 오라클 데이터베이스 클라이언트 설치 파일도 존재합니다.
오라클 데이터베이스 클라언트를 설치하면 C, C++, Java, .Net, Node.js, Python, PHP, R, Erlang, Perl, Ruby, Rust, Go, Julia등의 개발 언어 환경을 지원합니다. 

그중에 Java개발 언어에서 사용가능한 JDBC접속방식에 대해서 정리해보려고 합니다. 
Java 애플리케이션이 오라클 데이터베이스로 접속할때 JDBC Driver로 접속하는데, 여기서 OCI Driver, Thin Driver 두가지의 접속 Drvier가 있습니다.

- OCI Driver(Oracle Call Interface) : 오라클 클라이언트 설치가 필요하고(Native 라이브러리를 사용), 오라클 클라이언트에서 관리하고 있는 TNS정보를 이용하여 접속합니다.(Oracle Client + JDBC.jar파일 모두 필요) 오라클 데이터베이스에 접속하는 접속정보가 외부 파일로 저장되어 있기 때문에, 애플리케이션 관리자 나 데이터베이스 관리자가 접속정보를 관리할수 있습니다. 상대적으로 Thin Driver에 비해서 더빠른 성능을 제공한다고 되어 있습니다.

- Thin Driver : 오라클 클라이언트는 설치 하지 않아도 pure java를 통해서 접속이 가능합니다.(JDBC.jar파일만 필요) 접속정보는 소스나 Configure파일에서 Connection String로 관리합니다. 접속 정보가 소스코드내에 있기 때문에 애플리케이션 담당자가 접속정보를 관리합니다. 

각 개발자나 데이터베이스 관리자의 R&R에 따라서 접속 정보를 관리하겠지만, 데이터베이스 장애시 애플리케이션 가용성을 유지하는 관점에서 보면, 좀더 데이터베이스 관리자의 책임이 더 있지 않을까 싶습니다. 여기서 책임의 범위가 애매하지만 최소한 접속에 대한 가이드는 명확히 해야한다는 부분입니다.

### 클라이언트 접속 기술 및 동작 방식

데이터베이스 장애로 부터 애플리케이션 가용성 확보를 위하여 데이터베이스를 RAC(Real Application Cluster)로 구성합니다. 데이터베이스와 인스턴스의 개념을 먼저이해하는것이 좋을것 같습니다. 데이터베이스는 물리적으로 저장된 데이터파일들의 묶음(Set)을 의미하고 인스턴스는 애플리케이션이 접속해서 데이터베이스의 데이터를 Access하기 위해 실행되는 서버라고 이해하시면 좋습니다. 즉 RAC라는 환경은 하나의 데이터베이스에 여러개의 서버에 각 인스턴스가 실행되는 환경을 의미합니다. 따라서 인스턴스가 많아지면 많아질수록, 가용성이 높아지는 효과를 얻을수 있습니다. (인스턴스간에 데이터 정합성을 유지하는 매커니즘이 핵심기술입니다. 대부분의 데이터베이스 엔진들은 오라클만큼 성숙된 기술을 제공하지 못하고 있는것 같네요.)
여러개의 인스턴스가 서비스가 되면 애플리케이션은 그중에 하나의 인스턴스에 접속하여 SQL이 실행됩니다. SQL수행도중, 혹은 트랜잭션이 실행도중에 해당 인스턴스가 장애가 발생되어 중지된다면 어떻게 될까요?
일반적인 환경에서는 당연히 세션이 중지되는 현상이 발생되고 결국 애플리케이션이 담당한 업무에 영향이 발생되는 구조로 됩니다. 그러한 장애상황에서 애플리케이션 가용성을 높이기 위해서 아래와 같은 3가지 접속 기술을 제공합니다.

- CTF(Connection Timeout Failover)
  - RAC환경에서 인스턴스가 여러개 있다고 말씀드렸죠? 하나의 인스턴스에서 장애가 나면 나머지 인스턴스로 접속할수 있어야겠죠. CTF방식으로 접속하면 애플리케이션에서는 인스턴스 장애시 자동으로 reconnect(retry)해주는 로직이 필요합니다. 
  - 인스턴스 장애시 해당 인스턴스에 접속한 세션이 끊지만 재시도할때는 가용한 다른 인스턴스로 접속해주는 기능이 CTF입니다. 그렇기 때문에 접속정보에 모든 가용한 인스턴스 목록을 다 적어놔야겠죠.  
- TAF(Transparent Application Failover)
  - 인스턴스가 장애가 발생되면 기본적으로 해당 인스턴스에 접속한 세션이 끊기고, 해당 세션에서 처리중인 트랜잭션은 rollback이 됩니다. 
  - TAF를 사용하면 세션은 끊기지 않고 다른 인스턴스로 자동으로 세션이 failover됩니다. 하지만 실행되고 있는 트랜잭션은 자동으로 Rollback됩니다. 대신 트랜잭션이 없고 그냥 SELECT중인 업무인 경우 세션이 Failover되고나서도 이어서 계속 처리됩니다. 
- TAC(Transparent Application Continuity) : 
  - 12c부터 AC(Application Continuity)라는 개념이 나오게 나왔습니다. 인스턴스 장애시 트랜잭션자체를 보상하는 로직이 자동으로 시행됩니다. 보상한다는 로직이라면 인스턴스에서 장애가 발생되어 세션에서 하던 트랜잭션이 중지되어 Rollback된다면 자동으로 다른 인스턴스에 접속하여 실패한 트랜잭션을 재실행(replay)해주는 로직이 JDBC 내부에서 알아서 자동으로 실행됩니다. 따라서 세션이 끊기지 않고, 트랜재션 유실이 발생되지 않아 애플리케이션에서 인스턴스 장애 자체가 인지 되지 않습니다. (인스턴스가 장애나도 애플리케이션에서 인지가 안된다는 가용성을 유지하는 환경을 구성하고 있나요?), 18c부턴 TAC(Transparent Application Continuity)으로 발전하게 됩니다. 
  - AC를 사용하기 위해서는 애플리케이션 트랜잭션처리를 하기 위해서 트랜잭션 boundary를 명확하게 선언해야하는 코드 변경작업이 필요했습니다. TAC에서는 JDBC Drivce에서 자동으로 트랜잭션 Boudnary를 묵시적으로 처리하도록 되어 있어 AC보다 코드 변경작업이 적어집니다. (AC, TAC는 트랜잭션 Boudnary개념이 중요하고 애플리케이션에서 AC,TAC가 정상적으로 동작하도록 설계하는게 중요한 요소입니다.)

어떤 방식으로 접속하고 있나요? 아마 대부분 CTF방식으로 사용하고 있었을것으로 생각됩니다. 좀더 높은 고가용성을 유지 하기 위해서는 접속 방식만 바꿔도 더 나은 운영환경을 만들수 있습니다. 

### OCI, Thin 드라이버 선택 기준은?

각 Driver별로 지원되는 기능이 약간 다름입니다. 그렇기 때문에 어떤 기준을 적용하느냐에 따라 선택이 바뀔수도 있습니다. 

#### Driver별 특징

- OCI Driver
  - OCI Driver를 사용하기 위해서는 오라클 클라이언트 소프트웨어가 필요하므로 지원되는 OS환경여부를 확인하게는 먼저입니다. 
  - TNS 접속정보를 외부 파일로 관리하게 됩니다.  
  - 오라클 클라이언트를 통해서 접속하므로 기본적으로 CTF, TAF, TAC를 모두 지원합니다.  
- Thin Driver
  - 오라클 클라이언트 소프트웨어가 필요없고 필요한 JDBC.jar 파일만 사용하면됩니다. 
  - Connection String에서 접속정보를 모두 기술해야합니다. 소스코드 안에서 접속정보가 관리되며 설정이 쉽습니다. OS와는 독립적으로 관리가 가능합니다. 
  - CTF, TAC만 지원되고 TAF는 지원되지 않습니다. 

#### 드라이버 선택 기준

기본적으로 애플리케이션 가용성 레벨 및 데이터베이스 환경 변화에 따른 접속 정보관리 기준으로 접속 드라이버를 선택할수 있습니다. 물론 이외, 운영관점에서 여러가지 기준이 있을수 있습니다.

- 애플리케이션 가용성을 어느 수준에서 관리할것인지?
  - 가용성 수준은 CTF --> TAF --> TAC 순으로 높아집니다.
  - TAC 구성하기 위해서는 애플리케이션 코드레벨까지 가이드가 필요합니다.
- 접속정보를 어떻게 관리할것인지?
  - 데이터베이스가 새로운 환경으로 마이그레이션 되거나, 새로운 서버로 이전된다면 아이피가 변경될수 있습니다. 아이피 정보가 변경되면 어떻게 변경관리해야할까요?
  - 데이터베이스구성이 변경되면 어떻게 접속 정보를 관리할까요?(예 : RAC환경에서 인스턴스 추가)
  - 새로운 재해 복구 환경이 구성되면  어떻게 접속 정보를 관리할까요? (예 : Standby 환경이 구성되면? )

### 결론

오라클 데이터베이스 접속 방법과 동작방식에 대해서 간략하게 알아보았습니다. 사실 데이터베이스 관리자가 애플리케이션 담당자에게 접속 방식을 가이드하기 위해서는 많은 테스트가 필요합니다. 그리고 데이터베이스 설치 혹은 변경후에 가용성에 대해 검증하는 프로세스가 추가적으로 필요합니다. 

운영환경이 녹녹치 않아서 데이터베이스수에 비해서 데이터베이스 관리자가 많지 않죠. 운영하기 어려운 현실인것 같습니다. 

그래도 처음부터 고려되지 않았다면 지금부터라도 애플리케이션 관점에서 고민하고 내가 관리하는 데이터베이스가 안정적으로 운영될수 있는 기반을 마련하는것이 필요합니다. 그 기반의 시작점은 접속방식에 대한 이해한것 같습니다. 

최소한 TAF이상의 가용성은 유지하는것은 어떨까요?